# 灵魂谐振系统 - 开发进度跟踪

## 项目概述

**项目名称**: 灵魂谐振系统 (Soul-Attuned System)  
**目标平台**: 泰拉瑞亚 tModLoader 1.4.4  
**项目类型**: RPG成长型模组  

### 核心特性
- **经验与升级系统**: 动态XP公式，非线性升级曲线
- **世界谐振机制**: 等级上限受Boss击败进度限制（防止等级爆炸）
- **双轨成长系统**: 
  - 天赋点（每5级1点，共16点）- 质变奖励
  - 基础点（每级1点，共80点）- 量变提升
- **技能树UI**: 放射状"灵魂核心"界面，8个同心圆环
- **职业分支**: 近战、远程、法师、召唤师各2-3个专精分支
- **主动机制设计**: 以"当[玩家行为]触发时，产生[新效果]"替代被动数值加成

---

## 开发阶段划分

项目分为 **5个主要阶段**，预计开发周期：**3.5-5个月**

```
阶段 0: 基础架构搭建 (Foundation)          [1-2周]
    ↓
阶段 1: 核心数据系统 (Core Data)           [2-3周]
    ↓
阶段 2: UI 界面系统 (User Interface)       [3-4周]
    ↓
阶段 3: 技能节点实现 (Skill Nodes)         [4-6周]
    ↓
阶段 4: 网络同步与优化 (Netcode & Polish)  [2-3周]
    ↓
阶段 5: 内容完善与平衡 (Content & Balance) [2-3周]
```

---

## 当前进度状态

### 总体进度: 60% (阶段0-2已完成)

**当前阶段**: 阶段 3 - 技能节点实现
**状态**: 准备开始
**最后更新**: 2025-11-14

---

## 阶段详细进度

### ✅ 前期准备 (已完成)
- [x] 完成设计文档编写
  - [x] 技能树设计方案
  - [x] 节点设计文档
  - [x] 节点实现可行性分析
  - [x] 开发流程拆分文档
- [x] 建立Git仓库
- [x] 确定技术架构方案

### ✅ 阶段 0: 基础架构搭建 (已完成)

**预计时间**: 1-2周
**进度**: 3/3 子任务完成 (100%)

#### 0.1 项目初始化 ✅
- [x] 创建 tModLoader 1.4.4 模组项目
- [x] 配置 `build.txt` 和 `description.txt`
- [x] 建立版本控制（Git）和分支策略
- [x] 编写团队开发规范文档

#### 0.2 核心类框架 ✅
- [x] 创建 `SoulAttuned.cs` (主 Mod 类)
- [x] 创建 `SoulPlayer.cs` (继承 ModPlayer)
- [x] 创建 `SoulSystem.cs` (继承 ModSystem)
- [x] 创建配置文件结构 (Config)

#### 0.3 开发工具准备 ✅
- [x] 配置调试热键（用于测试）
- [x] 创建测试用的作弊命令（快速升级、解锁技能等）
- [x] 建立日志系统（用于调试网络同步）

**交付标准**: 能够加载模组并在游戏中看到模组名称，无报错。
**状态**: ✅ 已完成 - 基础架构已搭建完成，等待编译测试

---

### ✅ 阶段 1: 核心数据系统 (已完成)

**预计时间**: 2-3周
**进度**: 3/3 子任务完成 (100%)

#### 1.1 经验与升级系统 ✅
- [x] 实现动态 XP 公式
- [x] 实现升级曲线计算
- [x] 实现数据存储 (SaveData/LoadData)

#### 1.2 世界谐振系统 ✅
- [x] 创建谐振阶段枚举（8个阶段）
- [x] 实现等级上限门控
- [x] 实现谐振阶段检测

#### 1.3 升级奖励系统 ✅
- [x] 实现天赋点系统（每5级1点）
- [x] 实现基础点系统（每级1点）
- [x] 实现基础属性效果应用

**交付标准**: ✅ 已达成 - 击杀怪物能获得XP并升级，数据能正确保存和加载，等级上限受世界谐振限制。

---

### ✅ 阶段 2: UI 界面系统 (已完成)

**预计时间**: 3-4周
**进度**: 5/5 子任务完成 (100%)

#### 2.1 UI 架构设计 ✅
- [x] 创建 UI 服务层 (UIService)
- [x] 创建 UI 系统 (SoulUISystem)

#### 2.2 UI 状态与组件 ✅
- [x] 创建主界面状态 (SoulCoreUIState)
- [x] 创建可拖拽面板 (DraggablePanel)
- [x] 创建基础点分配面板 (BasicPointsPanel)
- [x] 创建天赋节点元素 (TalentNodeElement)

#### 2.3 UI 交互 ✅
- [x] 注册热键打开界面 (K键)
- [x] 实现基础点分配逻辑
- [x] 创建天赋树面板框架 (TalentTreePanel)

#### 2.4 天赋树UI框架 ✅
- [x] 创建天赋节点数据结构 (TalentNode)
- [x] 实现放射状布局（8个同心圆环）
- [x] 实现节点状态显示
- [x] 实现节点工具提示

**交付标准**: ✅ 已达成 - 按K键能打开/关闭UI，能够分配基础点并立即看到属性变化，天赋树UI框架已就绪。

---

### ⬜ 阶段 3: 技能节点实现 (未开始)

**预计时间**: 4-6周  
**进度**: 0/4 子任务完成

**开发优先级**: 召唤师 > 近战/远程 > 法师

#### 3.1 被动属性节点 (难度: ⭐ 低)
- [ ] 实现 HasTalent() 框架
- [ ] 实现各职业基础被动节点（每职业至少2个）

#### 3.2 事件驱动型节点 (难度: ⭐⭐ 中)
- [ ] 实现攻击命中触发节点
- [ ] 实现受伤触发节点

#### 3.3 主动技能节点 (难度: ⭐⭐⭐ 中高)
- [ ] 实现弹幕生成技能
- [ ] 实现状态改变技能

#### 3.4 复杂机制节点 (难度: ⭐⭐⭐⭐ 高)
- [ ] 实现连击/堆叠机制
- [ ] 实现甜蜜点机制
- [ ] 实现召唤物强化（绕过Bug）

**交付标准**: 每个职业至少实现2个T1节点，至少实现1个主动技能节点，所有节点在单人模式下正常工作。

---

### ⬜ 阶段 4: 网络同步与优化 (未开始)

**预计时间**: 2-3周
**进度**: 0/4 子任务完成
**难度**: ⭐⭐⭐⭐⭐ 极高

#### 4.1 核心数据同步
- [ ] 实现 ModPlayer 数据同步
  - [ ] clientClone 创建快照
  - [ ] SendClientChanges 检测变化
  - [ ] SyncPlayer 同步数据

#### 4.2 事件同步 (ModPacket)
- [ ] 设计消息协议（SoulPacketType枚举）
- [ ] 实现发送逻辑
- [ ] 实现接收逻辑（HandlePacket）

#### 4.3 弹幕同步
- [ ] 所有权检查（Owner = Main.myPlayer）
- [ ] 状态同步（netUpdate）
- [ ] 初始同步（netImportant）

#### 4.4 性能优化
- [ ] UI 性能优化
- [ ] 弹幕性能优化
- [ ] 计算优化

**交付标准**: 在2-4人多人游戏中无同步问题，所有技能效果对所有玩家可见，帧率稳定（60 FPS）。

---

### ⬜ 阶段 5: 内容完善与平衡 (未开始)

**预计时间**: 2-3周
**进度**: 0/4 子任务完成

#### 5.1 节点完整性
- [ ] 实现所有 T1 节点（4职业 × 2-3分支 × 2节点）
- [ ] 实现所有 T2 节点
- [ ] 实现所有 T3 节点
- [ ] 实现所有 T4 终极节点

#### 5.2 平衡性测试
- [ ] 肉山前测试（T1）- DPS 100-150
- [ ] 困难模式初期测试（T2）- DPS 400-600
- [ ] 困难模式后期测试（T3）- DPS 2000+

#### 5.3 用户体验优化
- [ ] 添加升级时的视觉/音效反馈
- [ ] 添加技能激活时的特效
- [ ] 实现天赋树的缩放和平移功能
- [ ] 添加技能说明的本地化支持

#### 5.4 配置与兼容性
- [ ] 创建完整的 Config 选项
- [ ] 测试与主流模组的兼容性（Calamity、Thorium等）

**交付标准**: 所有节点实现完毕且平衡，通过完整游戏流程测试，无已知Bug或崩溃。

---

## 已完成的功能列表

### 阶段 0: 基础架构 ✅
- ✅ 项目配置文件（build.txt, description.txt, .gitignore）
- ✅ 核心类框架（SoulAttuned.cs, SoulPlayer.cs, SoulSystem.cs, SoulConfig.cs）
- ✅ 开发工具（DebugCommands.cs, SoulLogger.cs）
- ✅ 数据持久化系统（SaveData/LoadData）

### 阶段 1: 核心数据系统 ✅
- ✅ 经验获取系统（SoulGlobalNPC.cs）
  - ✅ 动态XP公式：`XP = (MaxHP/100) × (1 + Defense/10) × (1 + Damage/25)`
  - ✅ Boss排除机制
  - ✅ 经验分享范围（1200像素）
- ✅ 世界谐振系统（ResonanceSystem.cs）
  - ✅ 8个谐振阶段枚举
  - ✅ Boss击败检测
  - ✅ 等级上限门控（10/20/30/40/50/60/70/80）
- ✅ 升级系统
  - ✅ 升级曲线：`BaseXP × (Level^1.5)`
  - ✅ 自动升级检测
  - ✅ 升级消息提示
- ✅ 奖励系统
  - ✅ 每级+1基础点
  - ✅ 每5级+1天赋点
- ✅ 基础属性效果
  - ✅ 灵魂伤害：每级+0.5%综合伤害
  - ✅ 灵魂防御：每级+1基础防御
  - ✅ 灵魂敏捷：每级+0.5%移动速度

### 阶段 2: UI界面系统 ✅
- ✅ UI架构（UIService.cs, SoulUISystem.cs）
  - ✅ UI服务层管理
  - ✅ UserInterface集成
  - ✅ 界面层渲染
- ✅ 可拖拽面板系统（DraggablePanel.cs）
  - ✅ 鼠标拖拽逻辑
  - ✅ UI缩放感知
  - ✅ 标题栏绘制
- ✅ 基础点分配面板（BasicPointsPanel.cs）
  - ✅ 三项属性显示（伤害、防御、敏捷）
  - ✅ 边际成本递增计算
  - ✅ 点击分配逻辑
  - ✅ 实时效果应用
- ✅ 天赋树UI框架
  - ✅ 天赋节点数据结构（TalentNode.cs）
  - ✅ 天赋树面板（TalentTreePanel.cs）
  - ✅ 放射状布局（8个同心圆环）
  - ✅ 节点元素（TalentNodeElement.cs）
  - ✅ 节点状态显示（5种状态）
  - ✅ 工具提示系统
- ✅ 热键系统
  - ✅ K键打开/关闭UI
  - ✅ ESC键关闭UI
  - ✅ 热键本地化

---

## 下一步计划

### 立即行动项
1. **编译测试阶段2功能**
   - 在tModLoader中编译模组
   - 测试UI打开/关闭
   - 测试基础点分配
   - 测试天赋树UI显示

2. **开始阶段3：技能节点实现**
   - 实现天赋节点解锁逻辑
   - 创建节点效果系统
   - 实现简单的被动节点

### 短期目标（4-6周）
- 完成阶段 3 的技能节点实现
- 实现各职业的基础被动节点
- 实现简单的主动技能节点

### 中期目标（1-2个月）
- 完成阶段 3 的技能节点实现
- 实现各职业的基础被动节点
- 实现简单的主动技能节点

### 长期目标（3-5个月）
- 完成所有5个阶段
- 实现所有职业的技能节点
- 完成网络同步和平衡性调整
- 发布第一个可玩版本

---

## 遇到的问题和解决方案

### 技术挑战

#### 1. UI 系统复杂性
**问题**: tModLoader 的 UI 系统需要大量样板代码，容易出错
**解决方案**: 采用"UI 服务"单例模式，将 UI 逻辑解耦（参考可行性分析 §4.2 方案1）
**状态**: 已规划，待实现

#### 2. 网络同步难度
**问题**: 网络同步是最容易出错的部分，新手100%会遇到问题
**解决方案**: 采用"混合网络模型"，严格分离"数据-事件-实体"同步（参考可行性分析 §4.2 方案2）
**状态**: 已规划，待实现

#### 3. 召唤物强化Bug
**问题**: ModifyWeaponDamage 钩子不会应用于持续更新伤害的仆从
**解决方案**: 使用 GlobalProjectile.OnSpawn + PreAI 变通方法
**状态**: 已规划，待实现

### 设计挑战

#### 1. 平衡性调整
**问题**: 如何确保技能节点不会破坏原版游戏平衡
**解决方案**: 严格遵循"守门人"原则，以Boss战为平衡锚点
**状态**: 持续进行中

#### 2. 主动机制设计
**问题**: 如何让"被动"的仆从玩法变得"主动"且"令人愉悦"
**解决方案**: 设计"统御者"和"鞭挞者"两个分支，分别支持不同玩法
**状态**: 已设计，待验证

---

## 关键开发规范

### 代码规范
- **命名约定**: 类名 `PascalCase`，字段 `camelCase`，常量 `UPPER_SNAKE_CASE`
- **注释要求**: 所有公共方法必须有 XML 文档注释
- **防御性编码**:
  - 所有 `LoadData` 必须检查键是否存在
  - 所有 `OnHitNPC` 必须检查 `proj.friendly`
  - 所有除法必须检查除数非零

### 测试规范
- **单人测试**: 每个功能完成后立即测试
- **多人测试**: 每个阶段完成后进行
- **性能测试**: 使用 tModLoader 的性能分析工具
- **兼容性测试**: 在干净环境和模组环境中分别测试

### 版本控制规范
- **分支策略**:
  - `main`: 稳定版本
  - `dev`: 开发分支
  - `feature/xxx`: 功能分支
- **提交规范**: `[阶段] 简短描述`，例如 `[阶段1] 实现经验获取逻辑`

---

## 参考文档

### 核心设计文档
- `技能树设计方案.md` - 核心架构、谐振进程、UI设计
- `节点设计.md` - 职业节点详细设计、平衡锚点
- `节点实现可行性分析.md` - API依赖、技术可行性、架构方案
- `开发流程拆分文档.md` - 详细任务清单、时间估算

### 技术参考
- tModLoader 1.4.4 官方文档: https://docs.tmodloader.net/
- ExampleMod 参考实现
- tModLoader GitHub: https://github.com/tModLoader/tModLoader

---

## 项目结构

```
SoulAttuned/
├── Core/                    # 核心数据和逻辑
│   ├── SoulPlayer.cs       # 玩家数据（经验、等级、升级系统）
│   ├── SoulGlobalNPC.cs    # NPC击杀和经验奖励
│   ├── ResonanceSystem.cs  # 世界谐振系统
│   └── TalentNode.cs       # 天赋节点数据结构
├── Systems/                 # 系统管理
│   ├── SoulSystem.cs       # 系统管理类
│   └── SoulConfig.cs       # 配置类
├── Utils/                   # 工具类
│   ├── SoulLogger.cs       # 日志工具
│   └── DebugCommands.cs    # 调试命令
├── UI/                      # UI界面系统
│   ├── UIService.cs        # UI服务层
│   ├── SoulUISystem.cs     # UI系统管理
│   ├── SoulCoreUIState.cs  # 主界面状态
│   ├── DraggablePanel.cs   # 可拖拽面板基类
│   ├── BasicPointsPanel.cs # 基础点分配面板
│   ├── TalentTreePanel.cs  # 天赋树面板
│   └── TalentNodeElement.cs # 天赋节点元素
└── SoulAttuned.cs          # 主模组类
```

## 更新日志

### 2025-11-14 (深夜)
- ✅ **完成阶段2：UI界面系统**
- 创建UI架构（UIService, SoulUISystem）
- 实现可拖拽面板系统（DraggablePanel）
- 实现基础点分配面板（BasicPointsPanel）
- 实现天赋树UI框架（TalentTreePanel, TalentNodeElement）
- 注册热键系统（K键打开UI）
- 创建天赋节点数据结构（TalentNode）
- 实现放射状布局和8个同心圆环
- 准备开始阶段3：技能节点实现

### 2025-11-14 (晚上)
- ✅ **完成阶段1：核心数据系统**
- 重构项目结构：创建Core/, Systems/, Utils/, UI/目录
- 实现经验获取系统（SoulGlobalNPC.cs）
- 实现世界谐振系统（ResonanceSystem.cs）
- 实现升级系统和奖励发放
- 实现基础属性效果（伤害、防御、移动速度）
- 更新所有文件的命名空间

### 2025-11-14 (下午)
- ✅ **完成阶段0：基础架构搭建**
- 创建核心类框架和数据持久化系统
- 实现调试命令系统和日志系统

---

**最后更新时间**: 2025-11-14
**文档维护者**: 开发团队
**文档版本**: v1.0

